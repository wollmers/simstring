#ifndef __UFT8STRING_H__
#define __UFT8STRING_H__

#include <string>

//int utf8_strlen(const string& s);

namespace simstring
{
  
template <
    class string_type
    >    
int utf8_strlen(
  //const std::string& str
  const string_type& str
)
{
    typedef typename string_type::value_type char_type;
    
    int c,i,ix,q;
    for (q=0, i=0, ix=str.length(); i < ix; i++, q++)
    {
        c = (unsigned char) str[i];
        if      (c>=0   && c<=127) i+=0;
        else if ((c & 0xE0) == 0xC0) i+=1;
        else if ((c & 0xF0) == 0xE0) i+=2;
        else if ((c & 0xF8) == 0xF0) i+=3;
        //else if (($c & 0xFC) == 0xF8) i+=4; // 111110bb //byte 5, unnecessary in 4 byte UTF-8
        //else if (($c & 0xFE) == 0xFC) i+=5; // 1111110b //byte 6, unnecessary in 4 byte UTF-8
        else return 0;//invalid utf8
    }
    return q;
}

template <
    class string_type
    > 
//std::string
string_type 
utf8_substr(
  //const std::string& str,
  const string_type& str,
  int start, 
  int leng
)
{
    typedef typename string_type::value_type char_type;

    if (leng==0) { return ""; }
    size_t c, i, ix, q, min=std::string::npos, max=std::string::npos;
    for (q=0, i=0, ix=str.length(); i < ix; i++, q++)
    {
        if (q==start){ min=i; }
        if (q<=start+leng || leng==std::string::npos){ max=i; }
 
        c = (unsigned char) str[i];
        //if      (c>=0   && c<=127) i+=0;
        if      (c<=127)             i+=0;
        else if ((c & 0xE0) == 0xC0) i+=1;
        else if ((c & 0xF0) == 0xE0) i+=2;
        else if ((c & 0xF8) == 0xF0) i+=3;
        //else if (($c & 0xFC) == 0xF8) i+=4; // 111110bb //byte 5, unnecessary in 4 byte UTF-8
        //else if (($c & 0xFE) == 0xFC) i+=5; // 1111110b //byte 6, unnecessary in 4 byte UTF-8
        else return "";//invalid utf8
    }
    if (q<=start+leng || leng==std::string::npos){ max=i; }
    if (min==std::string::npos || max==std::string::npos) { return ""; }
    return str.substr(min,max);
}
};

#endif/*__UFT8STRING_H__*/